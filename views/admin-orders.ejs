<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="branding">
            <img src="/public/images/logo.png" alt="Delulu Delata Logo" /><h1><a href="/">Delulu Delata</a></h1>
            <p>Pag Delata ang Problema...</p>
        </div>
        <nav class="header-nav">
            <ul>
                <li><a href="/users/admin">Dashboard</a></li>
                <li><a href="/admin/products">Manage Products</a></li>
                <li><a href="/admin/orders" class="active">Manage Orders</a></li>
                <li><a href="/users/admin?tab=users">User Management</a></li>
            </ul>
        </nav>
        <div class="auth-links">
            <span>Welcome, Admin!</span>
            <a href="/users/logout">Logout</a>
        </div>
    </header>
    <section class="dashboard-section">
        <h1>Order Management & Analytics</h1>

        <!-- Order Analytics -->
        <h2>Order Analytics</h2>
        <% if (orders && orders.length > 0) { %>
            <%
// Calculate analytics
let totalOrders = orders.length;
let totalRevenue = orders.reduce((sum, order) => sum + Number(order.totalAmount || 0), 0);
let statusCounts = {};
let statusLabels = ['to_pay', 'to_ship', 'to_receive', 'completed', 'refund', 'cancelled'];
statusLabels.forEach(status => statusCounts[status] = 0);
orders.forEach(order => {
    if (statusLabels.includes(order.orderStatus)) {
        statusCounts[order.orderStatus]++;
    }
});
let avgOrderValue = totalRevenue / totalOrders;

// Revenue by date (last 7 days)
let revenueByDate = {};
let today = new Date();
for (let i = 6; i >= 0; i--) {
    let date = new Date(today);
    date.setDate(today.getDate() - i);
    let key = date.toISOString().split('T')[0];
    revenueByDate[key] = 0;
}
orders.forEach(order => {
    if (order.createdAt) {
        let date = new Date(order.createdAt).toISOString().split('T')[0];
        if (revenueByDate.hasOwnProperty(date)) {
            revenueByDate[date] += Number(order.totalAmount || 0);
        }
    }
});
let dateLabels = Object.keys(revenueByDate);
let revenueData = Object.values(revenueByDate);

// Additional metrics
let pendingOrders = statusCounts.to_pay + statusCounts.to_ship + statusCounts.to_receive;
let successfulOrders = statusCounts.completed;
let failedOrders = statusCounts.refund + statusCounts.cancelled;
%>
        <!-- Summary Cards -->
        <div class="analytics-grid">
            <div class="analytics-card">
                <div class="card-icon">üìà</div>
                <div class="card-data">
                    <div class="metric"><%= totalOrders %></div>
                    <div class="label">Total Orders</div>
                </div>
            </div>
            <div class="analytics-card">
                <div class="card-icon">üí∞</div>
                <div class="card-data">
                    <div class="metric">‚Ç±<%= totalRevenue.toFixed(2) %></div>
                    <div class="label">Total Revenue</div>
                </div>
            </div>
            <div class="analytics-card">
                <div class="card-icon">üìä</div>
                <div class="card-data">
                    <div class="metric">‚Ç±<%= avgOrderValue.toFixed(2) %></div>
                    <div class="label">Avg Order Value</div>
                </div>
            </div>
            <div class="analytics-card">
                <div class="card-icon">‚è≥</div>
                <div class="card-data">
                    <div class="metric"><%= pendingOrders %></div>
                    <div class="label">Pending Orders</div>
                </div>
            </div>
            <div class="analytics-card">
                <div class="card-icon">‚úÖ</div>
                <div class="card-data">
                    <div class="metric"><%= successfulOrders %></div>
                    <div class="label">Successful Orders</div>
                </div>
            </div>
            <div class="analytics-card">
                <div class="card-icon">‚ùå</div>
                <div class="card-data">
                    <div class="metric"><%= failedOrders %></div>
                    <div class="label">Failed Orders</div>
                </div>
            </div>
        </div>

        <!-- Enhanced Charts -->
        <div class="advanced-charts">
            <div class="chart-section">
                <h3 style="color: var(--primary-color); text-align: center; margin-bottom: 1.5rem;">üìä Order Status Overview</h3>
                <div class="chart-content">
                    <% statusLabels.forEach(label => { %>
                    <div class="status-bar-item">
                        <div class="status-label"><%= label.replace('_', ' ').toUpperCase() %>: <%= statusCounts[label] || 0 %></div>
                        <div class="status-bar">
                            <div class="status-fill" style="width: <%= totalOrders > 0 ? ((statusCounts[label] || 0) / totalOrders * 100) : 0 %>% ; background: linear-gradient(90deg, #00ff88, #ffd700);">
                                <span class="percentage"><%= totalOrders > 0 ? Math.round((statusCounts[label] || 0) / totalOrders * 100) : 0 %>%</span>
                            </div>
                        </div>
                    </div>
                    <% }); %>
                </div>
            </div>
        </div>
        <% } else { %>
        <p style="text-align: center; color: var(--text-muted);">No orders data available yet.</p>
        <% } %>

        <h2>All Orders</h2>
        <% if (orders && orders.length > 0) { %>
        <table class="user-table">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Customer Email</th>
                    <th>Total Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                    <th>Created At</th>
                </tr>
            </thead>
            <tbody>
                <% orders.forEach(order => { %>
                <tr>
                    <td><%= order.orderId %></td>
                    <td><%= order.userEmail %></td>
                    <td>‚Ç±<%= Number(order.totalAmount || 0).toFixed(2) %></td>
                    <td><%= order.orderStatus %></td>
                    <td>
                        <form action="/admin/orders/update-status" method="POST" class="delete-form" style="display: inline;">
                            <input type="hidden" name="orderId" value="<%= order.orderId %>">
                            <select name="newStatus">
                                <option value="to_pay" <%= order.orderStatus === 'to_pay' ? 'selected' : '' %>>To Pay</option>
                                <option value="to_ship" <%= order.orderStatus === 'to_ship' ? 'selected' : '' %>>To Ship</option>
                                <option value="to_receive" <%= order.orderStatus === 'to_receive' ? 'selected' : '' %>>To Receive</option>
                                <option value="completed" <%= order.orderStatus === 'completed' ? 'selected' : '' %>>Completed</option>
                                <option value="refund" <%= order.orderStatus === 'refund' ? 'selected' : '' %>>Refund</option>
                                <option value="cancelled" <%= order.orderStatus === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                            </select>
                            <button type="submit" class="btn-edit" style="margin-top: 5px;">Update</button>
                        </form>
                    </td>
                    <td>
                        <% if (order.createdAt && order.createdAt.toLocaleString) { %>
                        <%= order.createdAt.toLocaleString() %>
                        <% } else { %>
                        <%= order.createdAt %>
                        <% } %>
                    </td>
                </tr>
                <% }) %>
            </tbody>
        </table>
        <% } else { %>
        <p>No orders have been placed yet.</p>
        <% } %>
    </section>
    <footer>
        <p>&copy; 2025 Delulu Delata. All rights reserved.</p>
    </footer>


</body>
</html>
